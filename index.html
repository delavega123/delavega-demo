<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delavega Earthmoving - AI Receptionist</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            min-height: 100vh;
            color: white;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 40px 0;
        }
        
        .logo {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .logo .dela {
            color: #f59e0b;
        }
        
        .logo .vega {
            color: #3b82f6;
        }
        
        .tagline {
            color: #888;
            font-size: 1.1em;
            font-style: italic;
        }
        
        .badge-container {
            margin-top: 15px;
        }
        
        .badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            margin: 3px;
        }
        
        .badge-ai {
            background: linear-gradient(90deg, #f59e0b, #ef4444);
            color: white;
        }
        
        .badge-memory {
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            color: white;
        }
        
        .badge-247 {
            background: linear-gradient(90deg, #10b981, #059669);
            color: white;
        }
        
        .agent-card {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 40px;
            margin: 20px 0;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .agent-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .agent-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f59e0b, #3b82f6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            position: relative;
        }
        
        .agent-avatar.speaking::after,
        .agent-avatar.listening::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid #f59e0b;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0; }
        }
        
        .agent-info h2 {
            font-size: 1.4em;
            margin-bottom: 5px;
        }
        
        .agent-info p {
            color: #888;
            font-size: 0.9em;
        }
        
        .mic-container {
            text-align: center;
            margin: 40px 0;
        }
        
        #micButton {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(145deg, #f59e0b, #d97706);
            color: white;
            font-size: 3em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 40px rgba(245, 158, 11, 0.4);
        }
        
        #micButton:hover {
            transform: scale(1.05);
        }
        
        #micButton.listening {
            background: linear-gradient(145deg, #10b981, #059669);
            animation: pulse 1s infinite;
            box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4);
        }
        
        #micButton.processing {
            background: linear-gradient(145deg, #3b82f6, #2563eb);
        }
        
        #micButton.speaking {
            background: linear-gradient(145deg, #8b5cf6, #7c3aed);
            animation: pulse 0.5s infinite;
        }
        
        #status {
            margin-top: 20px;
            font-size: 1.1em;
            color: #f59e0b;
        }
        
        .conversation {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 20px;
            max-height: 350px;
            overflow-y: auto;
            margin-top: 30px;
        }
        
        .message {
            padding: 15px 20px;
            margin: 10px 0;
            border-radius: 15px;
            max-width: 85%;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background: linear-gradient(90deg, #3b82f6, #2563eb);
            margin-left: auto;
            text-align: right;
        }
        
        .agent-message {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .config-panel {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .config-panel label {
            display: block;
            color: #888;
            font-size: 0.85em;
            margin-bottom: 5px;
        }
        
        .config-panel input {
            width: 100%;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 8px;
            background: rgba(0,0,0,0.5);
            color: white;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        
        .config-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .toggle-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #888;
            font-size: 0.85em;
        }
        
        .toggle-switch {
            position: relative;
            width: 46px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #444;
            transition: .3s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background: linear-gradient(90deg, #f59e0b, #3b82f6);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }
        
        .clear-btn {
            padding: 8px 16px;
            background: #ef4444;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 0.85em;
        }
        
        .clear-btn:hover {
            background: #dc2626;
        }
        
        .services-preview {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 30px;
        }
        
        .service-card {
            background: rgba(255,255,255,0.03);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .service-card .icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .service-card h3 {
            font-size: 0.95em;
            margin-bottom: 5px;
            color: #f59e0b;
        }
        
        .service-card p {
            color: #666;
            font-size: 0.8em;
        }
        
        .contact-info {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }
        
        .contact-info p {
            color: #888;
            font-size: 0.9em;
            margin: 5px 0;
        }
        
        .contact-info a {
            color: #f59e0b;
            text-decoration: none;
        }
        
        .powered-by {
            text-align: center;
            margin-top: 30px;
            color: #444;
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <span class="dela">DELA</span><span class="vega">VEGA</span> ğŸšœ
            </div>
            <p class="tagline">"Moving the World on Tracks"</p>
            <div class="badge-container">
                <span class="badge badge-ai">ğŸ¤– AI Receptionist</span>
                <span class="badge badge-memory">ğŸ§  Remembers Conversation</span>
                <span class="badge badge-247">ğŸ“ 24/7 Available</span>
            </div>
        </header>
        
        <div class="agent-card">
            <div class="agent-header">
                <div class="agent-avatar" id="agentAvatar">ğŸšœ</div>
                <div class="agent-info">
                    <h2>Delavega AI Receptionist</h2>
                    <p>Ask me about demolition, plant hire, or civil engineering</p>
                </div>
            </div>
            
            <div class="mic-container">
                <button id="micButton" onclick="toggleListening()">ğŸ¤</button>
                <p id="status">Click to start talking</p>
            </div>
            
            <div class="conversation" id="conversation">
                <div class="message agent-message">
                    ğŸ‘‹ Good day! Welcome to Delavega Earthmoving. I'm here to help with any questions about our demolition, plant hire, or civil engineering services. Click the microphone to chat!
                </div>
            </div>
            
            <div class="config-panel">
                <label>n8n Webhook URL:</label>
                <input type="text" id="webhookUrl" placeholder="https://automation.ryklief.org/webhook/voice-demo">
                
                <div class="config-row">
                    <label class="toggle-label">
                        <span>Auto-listen:</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoContinue" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </label>
                    
                    <label class="toggle-label">
                        <span>Premium voice:</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="premiumVoice" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </label>
                    
                    <button class="clear-btn" onclick="clearConversation()">ğŸ—‘ï¸ New Chat</button>
                </div>
            </div>
        </div>
        
        <div class="services-preview">
            <div class="service-card">
                <div class="icon">ğŸ—ï¸</div>
                <h3>Demolition</h3>
                <p>Buildings, garages, site clearing</p>
            </div>
            <div class="service-card">
                <div class="icon">ğŸš›</div>
                <h3>Plant Hire</h3>
                <p>Excavators, bobcats, trucks</p>
            </div>
            <div class="service-card">
                <div class="icon">ğŸ§±</div>
                <h3>Civil Engineering</h3>
                <p>Paving, retaining walls</p>
            </div>
        </div>
        
        <div class="contact-info">
            <p>ğŸ“ Lake Road, Zeekoevlei, Cape Town</p>
            <p>ğŸ“ <a href="tel:0217051690">021 705 1690</a> | <a href="tel:0730109827">073 010 9827</a></p>
            <p>âœ‰ï¸ <a href="mailto:delavega.earth@gmail.com">delavega.earth@gmail.com</a></p>
        </div>
        
        <p class="powered-by">AI Voice Agent Demo â€¢ Powered by Groq + ElevenLabs</p>
    </div>

    <audio id="audioPlayer" style="display: none;"></audio>

      <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DELAVEGA VOICE AGENT - BROWSER INTERFACE
        // Updated: Deepgram Premium Voice with Browser Fallback
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        let recognition = null;
        let isListening = false;
        let isSpeaking = false;
        let conversationHistory = [];
        let currentAudio = null;
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INITIALIZE SPEECH RECOGNITION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-ZA'; // South African English
            
            recognition.onstart = () => {
                isListening = true;
                document.getElementById('micButton').className = 'listening';
                document.getElementById('agentAvatar').classList.add('listening');
                document.getElementById('status').textContent = 'ğŸ§ Listening... Speak now';
            };
            
            recognition.onend = () => {
                isListening = false;
                document.getElementById('agentAvatar').classList.remove('listening');
                if (!isSpeaking) {
                    document.getElementById('micButton').className = '';
                }
            };
            
            recognition.onresult = async (event) => {
                const transcript = event.results[0][0].transcript;
                addMessage(transcript, 'user');
                document.getElementById('micButton').className = 'processing';
                document.getElementById('status').textContent = 'â³ Thinking...';
                await sendToAgent(transcript);
            };
            
            recognition.onerror = (event) => {
                if (event.error !== 'no-speech' && event.error !== 'aborted') {
                    document.getElementById('status').textContent = 'âŒ Error: ' + event.error;
                }
                document.getElementById('micButton').className = '';
                document.getElementById('agentAvatar').classList.remove('listening');
            };
        } else {
            document.getElementById('status').textContent = 'âŒ Speech recognition not supported. Please use Chrome.';
            document.getElementById('micButton').disabled = true;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CLEAR CONVERSATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function clearConversation() {
            conversationHistory = [];
            stopAllAudio();
            document.getElementById('conversation').innerHTML = `
                <div class="message agent-message">
                    ğŸ‘‹ Chat cleared! How can I help you with demolition, plant hire, or civil engineering?
                </div>
            `;
            document.getElementById('status').textContent = 'Click to start talking';
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // STOP ALL AUDIO
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function stopAllAudio() {
            // Stop HTML5 audio
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.src = '';
                currentAudio = null;
            }
            // Stop browser speech synthesis
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }
            isSpeaking = false;
            document.getElementById('micButton').className = '';
            document.getElementById('agentAvatar').classList.remove('speaking');
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TOGGLE LISTENING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function toggleListening() {
            // If currently speaking, stop and allow new input
            if (isSpeaking) {
                stopAllAudio();
                document.getElementById('status').textContent = 'Click to continue';
                return;
            }
            
            // Toggle listening
            if (isListening) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (e) {
                    // Already started, ignore
                }
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ADD MESSAGE TO CONVERSATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function addMessage(text, type) {
            const conversation = document.getElementById('conversation');
            const div = document.createElement('div');
            div.className = `message ${type}-message`;
            div.textContent = (type === 'user' ? 'ğŸ—£ï¸ ' : 'ğŸ¤– ') + text;
            conversation.appendChild(div);
            conversation.scrollTop = conversation.scrollHeight;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SEND MESSAGE TO AI AGENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function sendToAgent(message) {
            const webhookUrl = document.getElementById('webhookUrl').value;
            
            if (!webhookUrl) {
                addMessage('Please enter your webhook URL below.', 'agent');
                document.getElementById('micButton').className = '';
                document.getElementById('status').textContent = 'Enter webhook URL';
                return;
            }
            
            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        businessType: 'earthmoving',
                        history: conversationHistory
                    })
                });
                
                const data = await response.json();
                
                if (data.response) {
                    addMessage(data.response, 'agent');
                    
                    // Update conversation history
                    if (data.history) {
                        conversationHistory = data.history;
                    } else {
                        conversationHistory.push({ role: 'user', content: message });
                        conversationHistory.push({ role: 'assistant', content: data.response });
                    }
                    
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // PLAY AUDIO: Deepgram first, browser fallback
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    
                    if (data.audioAvailable && data.audio) {
                        console.log('ğŸµ Playing Deepgram premium voice');
                        playPremiumAudio(data.audio, data.audioFormat || 'mp3', data.response);
                    } else {
                        console.log('ğŸ”Š Falling back to browser voice');
                        speakWithBrowser(data.response);
                    }
                    
                } else {
                    addMessage('Sorry, I didn\'t get a response. Please try again.', 'agent');
                    document.getElementById('micButton').className = '';
                    document.getElementById('status').textContent = 'Click to try again';
                }
                
            } catch (error) {
                console.error('Error:', error);
                addMessage('Connection error. Please check the webhook URL.', 'agent');
                document.getElementById('micButton').className = '';
                document.getElementById('status').textContent = 'âŒ Connection error';
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PLAY PREMIUM AUDIO (Deepgram)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function playPremiumAudio(base64Audio, format, textFallback) {
            try {
                isSpeaking = true;
                document.getElementById('micButton').className = 'speaking';
                document.getElementById('agentAvatar').classList.add('speaking');
                document.getElementById('status').textContent = 'ğŸ”Š Speaking (Premium Voice)...';
                
                // Convert base64 to audio blob
                const binaryString = atob(base64Audio);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                const mimeType = format === 'wav' ? 'audio/wav' : 'audio/mpeg';
                const audioBlob = new Blob([bytes.buffer], { type: mimeType });
                const audioUrl = URL.createObjectURL(audioBlob);
                
                // Create audio element
                currentAudio = new Audio(audioUrl);
                
                currentAudio.onended = () => {
                    isSpeaking = false;
                    document.getElementById('micButton').className = '';
                    document.getElementById('agentAvatar').classList.remove('speaking');
                    document.getElementById('status').textContent = 'âœ… Click to continue';
                    URL.revokeObjectURL(audioUrl);
                    currentAudio = null;
                    
                    // Auto-listen after response
                    autoListen();
                };
                
                currentAudio.onerror = (e) => {
                    console.error('Audio playback error:', e);
                    URL.revokeObjectURL(audioUrl);
                    currentAudio = null;
                    // Fall back to browser voice
                    console.log('Premium audio failed, falling back to browser voice');
                    speakWithBrowser(textFallback);
                };
                
                currentAudio.play().catch(e => {
                    console.error('Audio play() failed:', e);
                    URL.revokeObjectURL(audioUrl);
                    currentAudio = null;
                    speakWithBrowser(textFallback);
                });
                
            } catch (e) {
                console.error('Premium audio error:', e);
                speakWithBrowser(textFallback);
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SPEAK WITH BROWSER VOICE (Fallback)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function speakWithBrowser(text) {
            if ('speechSynthesis' in window) {
                isSpeaking = true;
                document.getElementById('micButton').className = 'speaking';
                document.getElementById('agentAvatar').classList.add('speaking');
                document.getElementById('status').textContent = 'ğŸ”Š Speaking (Browser Voice)...';
                
                speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-ZA';
                utterance.rate = 0.95;
                utterance.pitch = 1.0;
                
                // Try to find a good voice
                const voices = speechSynthesis.getVoices();
                const preferredVoice = voices.find(v => 
                    v.lang.includes('en') && (v.name.includes('Female') || v.name.includes('Samantha'))
                ) || voices.find(v => v.lang.includes('en'));
                
                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                }
                
                utterance.onend = () => {
                    isSpeaking = false;
                    document.getElementById('micButton').className = '';
                    document.getElementById('agentAvatar').classList.remove('speaking');
                    document.getElementById('status').textContent = 'âœ… Click to continue';
                    autoListen();
                };
                
                utterance.onerror = () => {
                    isSpeaking = false;
                    document.getElementById('micButton').className = '';
                    document.getElementById('agentAvatar').classList.remove('speaking');
                    document.getElementById('status').textContent = 'âœ… Click to continue';
                };
                
                speechSynthesis.speak(utterance);
            } else {
                isSpeaking = false;
                document.getElementById('status').textContent = 'âœ… Click to continue';
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AUTO-LISTEN AFTER RESPONSE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function autoListen() {
            const autoContinue = document.getElementById('autoContinue').checked;
            if (autoContinue && recognition) {
                setTimeout(() => {
                    if (!isSpeaking && !isListening) {
                        try {
                            recognition.start();
                        } catch (e) {
                            // Ignore - already started or other issue
                        }
                    }
                }, 600);
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LOAD BROWSER VOICES (for fallback)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        if ('speechSynthesis' in window) {
            speechSynthesis.getVoices();
            speechSynthesis.onvoiceschanged = () => {
                speechSynthesis.getVoices();
            };
        }
    </script>
</body>
</html>